# CASC-lite n=50 バッチラン (2025-10-30)

## 実験コンセプト
- 固定サンプル数 `n=50` まで拡張した自己一貫性投票で、本当に精度が単調に向上するのかを確認する。
- 既存の n={1,3,5,7} ベースラインで観測した「増票による改善」が高 n でも継続するか検証し、閾値設計や信頼度指標追加の参考データを得る。

## 実行設定
- コマンド:
  ```bash
  python scripts/run_fixed_batch.py \
    --config src/casc_lite/config/default.yaml \
    --data data/gsm8k_full.jsonl \
    --output_dir results/n50_batch \
    --n_fixed 50 \
    --gpus 0,1,2,3,4,5,6 \
    --num_shards 7 \
    --extra_args "--posthoc_n_values 1,2,3,4,5,6,7,10,15,20,30,40,50 --save_entropy_tokens 32"
  ```
- モデル / バックエンド: `meta-llama/Meta-Llama-3-8B-Instruct` (HF Transformers)
- データセット: GSM8K full (8,792 問)
- サンプリング: `temperature=0.7`, `top_p=0.9`, `max_new_tokens=256`
- ログ: 各シャードは 1,256 問を処理し、合計 7 シャードで全件をカバー。

## 後処理概要
1. `AdaptiveSampler` (fixed モード) が 50 回まで逐次生成し、canonical 化した回答で多数決。
2. `summarize_prefix_result` が `posthoc_n_values` ごとに prefix を切り出し、多数決結果をリプレイ。
3. `Evaluator` が厳密一致判定を行い、`persist_results` が `*_examples.csv` と `aggregate.csv` に出力。
4. 7 つの `*_examples.csv`（`results/n50_batch/20251030*_fixed_examples.csv`）を連結して再集計し、全 8,792 行の正誤とレイテンシを確認。
   `results/n50_batch/aggregate.csv` に主要指標を追記。

## 集計結果（全 8,792 問）
| n | 厳密精度 | Δ精度 (対直前) | 平均レイテンシ [s] | 備考 |
|---|---------|---------------|--------------------|------|
| 1 | 0.4567 | –           | 0.39 | 1 サンプル多数決 |
| 2 | 0.4567 | +0.0000 | 0.79 | 同票時は先着優先で変化なし |
| 3 | 0.5432 | +0.0866 | 1.18 | 922 件で誤答→正答、161 件で逆転 |
| 4 | 0.6098 | +0.0666 | 1.58 | 734 件で改善、149 件で逆転 |
| 5 | 0.6482 | +0.0384 | 1.97 | 500 件で改善、162 件で逆転 |
| 6 | 0.6740 | +0.0258 | 2.37 | 397 件で改善、170 件で逆転 |
| 7 | 0.6953 | +0.0213 | 2.76 | 343 件で改善、156 件で逆転 |
| 10 | 0.7349 | +0.0396 | 3.94 | 519 件で改善、171 件で逆転 |
| 15 | 0.7635 | +0.0286 | 5.92 | 433 件で改善、181 件で逆転 |
| 20 | 0.7803 | +0.0167 | 7.89 | 282 件で改善、135 件で逆転 |
| 30 | 0.7954 | +0.0151 | 11.83 | 260 件で改善、127 件で逆転 |
| 40 | 0.8048 | +0.0094 | 15.78 | 180 件で改善、97 件で逆転 |
| 50 | 0.8099 | +0.0051 | 19.72 | 119 件で改善、74 件で逆転 |

> Δ精度は 1 つ前の行との差分。レイテンシはポストホックでサンプル遅延を線形加算した値（実際の並列実行より悲観的）。

- 集計では n を増やすごとに純増が劣化を上回り、最終的に 80.99% まで到達。
- ただし 1,309 件は途中で「正→誤」へ反転しており、単調増加は保証されていない。

### 補足統計
- `n=50` 正解の平均投票マージンは 0.557、誤答は 0.372。僅差票が誤答側に偏ると、50 票集めても覆らない事例が多い。
- プレフィックス平均エントロピーと `n=50` 正解率との相関係数は +0.083。エントロピー単独では成功/失敗の判別力が低い。
- 任意の n 増分で一度でも誤答に落ちたサンプルは 1,309 件（全体の 14.9%）。改善のほうが多数のため集計上は単調増加に見える。
- `results/n50_batch/aggregate.csv` ではシャードごとの平均精度・レイテンシも確認でき、`accuracy_strict` は 0.76〜0.83（平均 0.81）、`avg_latency` は 17.8〜20.2 秒の範囲に収まった。ばらつきは 1.5 秒弱で、GPU ごとの処理負荷差は限定的。

### 付随ファイル
- `results/n50_batch/headroom_summary.csv` は全 8,792 問を横断して n ごとの精度と直前との差分を記録したもの（例: `n=10` で +4.7 pt）。前節のテーブルと同値だが、外部ツールで読み出しやすいよう terse に整形されている。
- `results/n50_batch/20251030*_fixed_examples.csv` が各シャードの明細。再現のため、一時シャード分割ファイルは `results/n50_batch/casc_shards_*/shard_XXX.jsonl` に残っている（各 1,256 問）。
- 追加解析スクリプトから `headroom_summary.csv` を読み取れば、任意の n でのヘッドルーム（累積精度）をそのまま利用できる。

### 詳細診断（`results/n50_batch/20251030*_fixed_examples.csv` 集計）
- 初回で正解できた問題は 4,015 件 (45.7%)。最初の成功が `n=3` にずれ込むケースが 922 件、`n=4` が 657 件。`n=20` 以降になってようやく正解する問題が 401 件、最後まで正解に到達しない問題が 1,222 件 (13.9%) 存在する。
- `n=50` まで到達して初めて正解する 41 件の平均投票マージンは 0.261。多数決で救済できた難問は票差が非常に小さく、追加サンプルを増やしても安定しづらい。
- 反対に `n=1` で正解する問題の平均投票マージンは 0.610 と大きく、単一サンプルでも自信を持てるケースが多い。初回正解が遅い問題ほどマージンが逓減し、`n=20` 時点で平均 0.33、`n=30` で 0.295 まで低下。
- エントロピーの平均値は、「早期に正解する問題」ほどやや高く (`n=1` 平均 0.625)、「高 n まで迷う問題」ではむしろ低迷 (`n=50` 平均 0.501)。これはエントロピーだけでは難易度を弁別できないことを示唆する。
- 増票ステップごとの改善/悪化件数は \(n=2\rightarrow3\) で +922 / −161 件、\(n=40\rightarrow50\) でも +119 / −74 件。後段になるほど純増幅が小さくなるが、50 票でも一定の救済が残っている。

**特徴量との相関**

| Pair | 相関係数 |
|------|----------|
| `correct_n50` × `vote_margin` | +0.37 |
| `correct_n50` × `second_vote_ratio` | −0.16 |
| `correct_n50` × `entropy` | +0.08 |
| `correct_n50` × `latency_seconds` | −0.10 |
| `gain_n1→n50` × `vote_margin` | −0.11 |
| `gain_n1→n50` × `second_vote_ratio` | +0.02 |

- 相関マトリクス全体は `figures/n50_batch/correlation_heatmap.png` を参照。投票マージンが最も強く精度に寄与し、プレフィックスエントロピーは弱い正の相関にとどまる。
- `gain_n1→n50` と `vote_margin` の負相関は、票差が小さい問題ほど追加サンプルで救済されやすいことを意味する。

**特徴量別の精度推移**（図は `figures/n50_batch/accuracy_vs_*.png`）

- 投票マージン 0.25 未満のケースでも精度は 51% 程度あるが、0.75 超では 95% 以上まで伸びる。マージンは信頼度推定の最有力候補。
- セカンドボート比率が 0.2 を超えると精度が 73% 以下に落ち込み、0.4 に迫ると 60% を切る。接戦検知に有効。
- プレフィックスエントロピーは中間帯 (0.37〜0.88) で最も精度が高く、極端に低い場合（0.19 以下）や高い場合（>1.09）では緩やかに低下。単独指標としての判別力は限定的。
- レイテンシは 18.4 秒未満で 82.5%、21 秒超では 70% 付近まで下がる。長時間生成は難問である傾向。
- 散布図 `figures/n50_batch/entropy_vs_vote_margin_scatter.png` から、高エントロピーでも投票マージンが高ければ正答率が維持されることが視覚的に確認できる。

改善寄与との関係は `figures/n50_batch/gain_correlations.png` で棒グラフ化し、エントロピーよりも投票マージンのほうが「追加 49 サンプルの価値」を左右することを示した。

**厳密精度と増分**（全 8,792 問）

| n | Accuracy | Δ vs prev |
|---|---------|----------|
| 1 | 0.4567 | - |
| 2 | 0.4567 | +0.0000 |
| 3 | 0.5432 | +0.0866 |
| 4 | 0.6098 | +0.0665 |
| 5 | 0.6482 | +0.0384 |
| 6 | 0.6740 | +0.0258 |
| 7 | 0.6953 | +0.0213 |
| 10 | 0.7349 | +0.0396 |
| 15 | 0.7635 | +0.0287 |
| 20 | 0.7803 | +0.0167 |
| 30 | 0.7954 | +0.0151 |
| 40 | 0.8048 | +0.0094 |
| 50 | 0.8099 | +0.0051 |

**初回正解位置の分布**

| First correct at n | Count | Share |
|-------------------|-------|-------|
| 1 | 4015 | 45.667% |
| 2 | 0 | 0.000% |
| 3 | 922 | 10.487% |
| 4 | 657 | 7.473% |
| 5 | 434 | 4.936% |
| 6 | 282 | 3.207% |
| 7 | 213 | 2.423% |
| 10 | 368 | 4.186% |
| 15 | 277 | 3.151% |
| 20 | 156 | 1.774% |
| 30 | 124 | 1.410% |
| 40 | 81 | 0.921% |
| 50 | 41 | 0.466% |
| Never | 1222 | 13.899% |

**ステップごとの改善 / 劣化件数**

| Transition | Gains | Losses |
|-----------|-------|--------|
| 1→2 | 0 | 0 |
| 2→3 | 922 | 161 |
| 3→4 | 734 | 149 |
| 4→5 | 500 | 162 |
| 5→6 | 397 | 170 |
| 6→7 | 343 | 156 |
| 7→10 | 519 | 171 |
| 10→15 | 433 | 181 |
| 15→20 | 282 | 135 |
| 20→30 | 260 | 127 |
| 30→40 | 180 | 97 |
| 40→50 | 119 | 74 |

図形化した指標は `figures/n50_batch/accuracy_vs_n50.png`（精度カーブ）と `figures/n50_batch/gain_loss_per_step.png`（ステップごとの改善/劣化ヒストグラム）で確認できる。

## 追加スナップショット（10 問サンプル）
- コマンド:
  ```bash
  CUDA_VISIBLE_DEVICES=0 PYTHONPATH=src python scripts/collect_n50_sample.py \
    --config src/casc_lite/config/default.yaml \
    --data data/gsm8k_full.jsonl \
    --output_dir results/n50_debug \
    --num_examples 10 \
    --n_fixed 50 \
    --posthoc_n_values 1,3,5,10,20,30,40,50 \
    --save_entropy_tokens 32
  ```
- 成果物: `results/n50_debug/20251031_012815_fixed_examples.csv`, `results/n50_debug/20251031_012815_fixed_raw_outputs.json`。

| n | 正解件数 /10 | 備考 |
|---|---------------|------|
| 1 | 5 | 低エントロピー問題は即正解、残りは追加票が必要 |
| 3 | 7 | n=1 誤答 2 件を救済 |
| 5 | 7 | 票構成は n=3 とほぼ同一 |
| 10 | 6 | 一度正解を逃す同票競合が発生 |
| 20 | 8 | 追加票で 3 件を修正 |
| 30 | 8 | n=20 と同一の多数派を維持 |
| 40 | 8 | |
| 50 | 8 | index 4,9 は誤答 312 が多数派のまま |

サンプル平均エントロピーは 0.50、平均投票マージンは 0.502。`n=1` 誤答 → `n=50` 正答に反転したのは index 3,7,8 の 3 件で、いずれも 50 票時のマージンが 0.6 前後まで上昇。残る index 4,9 は 50 票の過半数が誤答 312 を支持し続けており、単純多数決では矯正できないケースが確認できた。

## 主な観察ポイント
- n=2 は 1:1 の同票時に最初の回答を採用する仕様ゆえ、精度は n=1 と等しい。
- 高 n でも改善が残る一方、票が割れて逆転するケースが存在し、単純な「多数決で必ず良くなる」わけではない。
- レイテンシはポストホックの単純加算なので、実機の並列推論ではこれより短縮される見込み。

## 今後のアクション案
1. `--save_completions` を付けた部分実行で 50 本すべての生成を目視し、逆転ケース（例: index 41）を分析。
2. n=50 の投票分布と `avg_logprob` を使って信頼度モデル (Cascade-NN など) を再学習し、高コスト時の早期打ち切りを検討。
3. n を増やしても収束しない高エントロピー問題に対し、自己検証プロンプトや数値正規化の実装（`todo.md` 記載）を優先実装。
