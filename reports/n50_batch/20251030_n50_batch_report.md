# CASC-lite n=50 バッチラン (2025-10-30)

## 実験コンセプト
- 固定サンプル数 `n=50` まで拡張した自己一貫性投票で、本当に精度が単調に向上するのかを確認する。
- 既存の n={1,3,5,7} ベースラインで観測した「増票による改善」が高 n でも継続するか検証し、閾値設計や信頼度指標追加の参考データを得る。

## 実行設定
- コマンド:
  ```bash
  python scripts/run_fixed_batch.py \
    --config src/casc_lite/config/default.yaml \
    --data data/gsm8k_full.jsonl \
    --output_dir results/n50_batch \
    --n_fixed 50 \
    --gpus 0,1,2,3,4,5,6 \
    --num_shards 7 \
    --extra_args "--posthoc_n_values 1,2,3,4,5,6,7,10,15,20,30,40,50 --save_entropy_tokens 32"
  ```
- モデル / バックエンド: `meta-llama/Meta-Llama-3-8B-Instruct` (HF Transformers)
- データセット: GSM8K full (8,792 問)
- サンプリング: `temperature=0.7`, `top_p=0.9`, `max_new_tokens=256`
- ログ: 各シャードは 1,256 問を処理し、合計 7 シャードで全件をカバー。

## 後処理概要
1. `AdaptiveSampler` (fixed モード) が 50 回まで逐次生成し、canonical 化した回答で多数決。
2. `summarize_prefix_result` が `posthoc_n_values` ごとに prefix を切り出し、多数決結果をリプレイ。
3. `Evaluator` が厳密一致判定を行い、`persist_results` が `*_examples.csv` と `aggregate.csv` に出力。
4. 7 つの `*_examples.csv` を連結して再集計し、全 8,792 行の正誤とレイテンシを確認。

## 集計結果（全 8,792 問）
| n | 厳密精度 | Δ精度 (対直前) | 平均レイテンシ [s] | 備考 |
|---|---------|---------------|--------------------|------|
| 1 | 0.4567 | –           | 0.39 | 1 サンプル多数決 |
| 2 | 0.4567 | +0.0000 | 0.79 | 同票時は先着優先で変化なし |
| 3 | 0.5432 | +0.0866 | 1.18 | 922 件で誤答→正答、161 件で逆転 |
| 4 | 0.6098 | +0.0666 | 1.58 | 734 件で改善、149 件で逆転 |
| 5 | 0.6482 | +0.0384 | 1.97 | 500 件で改善、162 件で逆転 |
| 6 | 0.6740 | +0.0258 | 2.37 | 397 件で改善、170 件で逆転 |
| 7 | 0.6953 | +0.0213 | 2.76 | 343 件で改善、156 件で逆転 |
| 10 | 0.7349 | +0.0396 | 3.94 | 519 件で改善、171 件で逆転 |
| 15 | 0.7635 | +0.0286 | 5.92 | 433 件で改善、181 件で逆転 |
| 20 | 0.7803 | +0.0167 | 7.89 | 282 件で改善、135 件で逆転 |
| 30 | 0.7954 | +0.0151 | 11.83 | 260 件で改善、127 件で逆転 |
| 40 | 0.8048 | +0.0094 | 15.78 | 180 件で改善、97 件で逆転 |
| 50 | 0.8099 | +0.0051 | 19.72 | 119 件で改善、74 件で逆転 |

> Δ精度は 1 つ前の行との差分。レイテンシはポストホックでサンプル遅延を線形加算した値（実際の並列実行より悲観的）。

- 集計では n を増やすごとに純増が劣化を上回り、最終的に 80.99% まで到達。
- ただし 1,309 件は途中で「正→誤」へ反転しており、単調増加は保証されていない。

## 主な観察ポイント
- n=2 は 1:1 の同票時に最初の回答を採用する仕様ゆえ、精度は n=1 と等しい。
- 高 n でも改善が残る一方、票が割れて逆転するケースが存在し、単純な「多数決で必ず良くなる」わけではない。
- レイテンシはポストホックの単純加算なので、実機の並列推論ではこれより短縮される見込み。

## 今後のアクション案
1. `--save_completions` を付けた部分実行で 50 本すべての生成を目視し、逆転ケース（例: index 41）を分析。
2. n=50 の投票分布と `avg_logprob` を使って信頼度モデル (Cascade-NN など) を再学習し、高コスト時の早期打ち切りを検討。
3. n を増やしても収束しない高エントロピー問題に対し、自己検証プロンプトや数値正規化の実装（`todo.md` 記載）を優先実装。
